---
jupytext:
  text_representation:
    extension: .md
    format_name: myst
kernelspec:
  display_name: Python 3
  language: python
  name: python3
heading-map:
  vectorized-operations: ุนููุงุช ุจุฑุฏุงุฑ ุดุฏู
  problem-statement: ุจุงู ูุณุฆูู
  numpy-vectorization: ุจุฑุฏุงุฑโุณุงุฒ NumPy
  a-comparison-with-numba: ููุงุณู ุจุง Numba
  parallelized-numba: Numba ููุงุฒ ุดุฏู
  vectorized-code-with-jax: ฺฉุฏ ุจุฑุฏุงุฑ ุดุฏู ุจุง JAX
  jax-plus-vmap: JAX ุจู ุนูุงูู vmap
  version-1: ูุณุฎู 1
  vmap-version-2: ูุณุฎู 2 vmap
  summary: ุฎูุงุตู
  sequential-operations: ุนููุงุช ุชุฑุชุจ
  numba-version: ูุณุฎู Numba
  jax-version: ูุณุฎู JAX
---

(parallel)=
```{raw} jupyter
<div id="qe-notebook-header" align="right" style="text-align:right;">
        <a href="https://quantecon.org/" title="quantecon.org">
                <img style="width:250px;display:inline;" width="250px" src="https://assets.quantecon.org/img/qe-menubar-logo.svg" alt="QuantEcon">
        </a>
</div>
```

# NumPy ุฏุฑ ููุงุจู Numba ุฏุฑ ููุงุจู JAX

ุฏุฑ ุณุฎูุฑุงูโูุง ูุจูุ ุณู ฺฉุชุงุจุฎุงูู ุงุตู ุจุฑุง ูุญุงุณุจุงุช ุนูู ู ุนุฏุฏ ุฑุง ุจุญุซ ฺฉุฑุฏู:

* [NumPy](numpy)
* [Numba](numba)
* [JAX](jax_intro)

ฺฉุฏุงู ฺฉ ุฑุง ุจุงุฏ ุฏุฑ ูุฑ ูููุนุช ุงุณุชูุงุฏู ฺฉููุ

ุงู ุณุฎูุฑุงู ุจู ุขู ุณุคุงู ูพุงุณุฎ ูโุฏูุฏุ ุญุฏุงูู ุชุง ุญุฏุ ุจุง ุจุญุซ ุฏุฑ ููุฑุฏ ุจุฑุฎ ููุงุฑุฏ ุงุณุชูุงุฏู.

ูุจู ุงุฒ ุดุฑูุนุ ุชูุฌู ูโฺฉูู ฺฉู ุฏู ููุฑุฏ ุงูู ฺฉ ุฌูุช ุทุจุน ูุณุชูุฏ: NumPy ู Numba ุจู ุฎูุจ ุจุง ูู ฺฉุงุฑ ูโฺฉููุฏ.

JAXุ ุงุฒ ุณู ุฏฺฏุฑุ ุจู ุชููุง ูโุงุณุชุฏ.

ููฺฏุงู ุจุฑุฑุณ ูุฑ ุฑูฺฉุฑุฏุ ูู ุชููุง ฺฉุงุฑุง ู ุฑุฏ ูพุง ุญุงูุธูุ ุจูฺฉู ูุถูุญ ู ุณูููุช ุงุณุชูุงุฏู ุฑุง ูุฒ ุฏุฑ ูุธุฑ ุฎูุงูู ฺฏุฑูุช.

ุนูุงูู ุจุฑ ุขูฺู ุฏุฑ Anaconda ููุฌูุฏ ุงุณุชุ ุงู ุณุฎูุฑุงู ุจู ฺฉุชุงุจุฎุงููโูุง ุฒุฑ ูุงุฒ ุฏุงุฑุฏ:

```{code-cell} ipython3
---
tags: [hide-output]
---
!pip install quantecon jax
```

```{include} _admonition/gpu.md
```

ูุง ุงุฒ import ูุง ุฒุฑ ุงุณุชูุงุฏู ุฎูุงูู ฺฉุฑุฏ.

```{code-cell} ipython3
import random
import numpy as np
import quantecon as qe
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d.axes3d import Axes3D
from matplotlib import cm
import jax
import jax.numpy as jnp
```

## ุนููุงุช ุจุฑุฏุงุฑ ุดุฏู

ุจุฑุฎ ุนููุงุช ุฑุง ูโุชูุงู ุจู ุทูุฑ ฺฉุงูู ุจุฑุฏุงุฑ ฺฉุฑุฏ --- ุชูุงู ุญูููโูุง ุจู ุฑุงุญุช ุญุฐู ูโุดููุฏ ู ุนููุงุช ุนุฏุฏ ุจู ูุญุงุณุจุงุช ุฑู ุขุฑุงูโูุง ุชููู ูโุงุจูุฏ.

ุฏุฑ ุงู ุญุงูุชุ ฺฉุฏุงู ุฑูฺฉุฑุฏ ุจูุชุฑู ุงุณุชุ

### ุจุงู ูุณุฆูู

ูุณุฆูู ุจุดููโุณุงุฒ ุชุงุจุน $f$ ุงุฒ ุฏู ูุชุบุฑ $(x,y)$ ุฑู ูุฑุจุน $[-a, a] \times [-a, a]$ ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ.

ุจุฑุง $f$ ู $a$ ุจุงุฏ ุงูุชุฎุงุจ ฺฉูู

$$
f(x,y) = \frac{\cos(x^2 + y^2)}{1 + x^2 + y^2}
\quad \text{ู} \quad
a = 3
$$

ุฏุฑ ุงูุฌุง ูููุฏุงุฑ $f$ ุขูุฏู ุงุณุช

```{code-cell} ipython3

def f(x, y):
    return np.cos(x**2 + y**2) / (1 + x**2 + y**2)

xgrid = np.linspace(-3, 3, 50)
ygrid = xgrid
x, y = np.meshgrid(xgrid, ygrid)

fig = plt.figure(figsize=(10, 8))
ax = fig.add_subplot(111, projection='3d')
ax.plot_surface(x,
                y,
                f(x, y),
                rstride=2, cstride=2,
                cmap=cm.jet,
                alpha=0.7,
                linewidth=0.25)
ax.set_zlim(-0.5, 1.0)
ax.set_xlabel('$x$', fontsize=14)
ax.set_ylabel('$y$', fontsize=14)
plt.show()
```

ุจู ุฎุงุทุฑ ุงู ุชูุฑูุ ูุง ุงุฒ ุฑูุด brute force ุจุฑุง ุจุดููโุณุงุฒ ุงุณุชูุงุฏู ุฎูุงูู ฺฉุฑุฏ.

1. $f$ ุฑุง ุจุฑุง ุชูุงู $(x,y)$ ุฏุฑ ฺฉ ุดุจฺฉู ุฑู ูุฑุจุน ุงุฑุฒุงุจ ฺฉูุฏ.
1. ุญุฏุงฺฉุซุฑ ููุงุฏุฑ ูุดุงูุฏู ุดุฏู ุฑุง ุจุฑฺฏุฑุฏุงูุฏ.

ููุท ุจุฑุง ูุดุงู ุฏุงุฏู ุงุฏูุ ุฏุฑ ุงูุฌุง ฺฉ ูุณุฎู ุบุฑ ุจุฑุฏุงุฑ ุดุฏู ุงุณุช ฺฉู ุงุฒ ุญูููโูุง Python ุงุณุชูุงุฏู ูโฺฉูุฏ.

```{code-cell} ipython3
grid = np.linspace(-3, 3, 50)
m = -np.inf
for x in grid:
    for y in grid:
        z = f(x, y)
        if z > m:
            m = z
```


### ุจุฑุฏุงุฑโุณุงุฒ NumPy

ุงฺฏุฑ ุจู ุจุฑุฏุงุฑโุณุงุฒ ุจู ุณุจฺฉ NumPy ุชุบุฑ ุฏููุ ูโุชูุงูู ุงุฒ ฺฉ ุดุจฺฉู ุจุณุงุฑ ุจุฒุฑฺฏุชุฑ ุงุณุชูุงุฏู ฺฉูู ู ฺฉุฏ ูุณุจุชุงู ุณุฑุน ุงุฌุฑุง ูโุดูุฏ.

ุฏุฑ ุงูุฌุง ุงุฒ `np.meshgrid` ุจุฑุง ุงุฌุงุฏ ุดุจฺฉูโูุง ูุฑูุฏ ุฏูุจุนุฏ `x` ู `y` ุงุณุชูุงุฏู ูโฺฉูู ุจู ฺฏูููโุง ฺฉู `f(x, y)` ุชูุงู ุงุฑุฒุงุจโูุง ุฑุง ุฑู ุดุจฺฉู ุญุงุตูุถุฑุจ ุชููุฏ ูโฺฉูุฏ.

(ุงู ุงุณุชุฑุงุชฺ ุจู Matlab ุจุงุฒูโฺฏุฑุฏุฏ.)

```{code-cell} ipython3
grid = np.linspace(-3, 3, 3_000)
x, y = np.meshgrid(grid, grid)

with qe.Timer(precision=8):
    z_max_numpy = np.max(f(x, y))

print(f"NumPy result: {z_max_numpy:.6f}")
```

ุฏุฑ ูุณุฎู ุจุฑุฏุงุฑ ุดุฏูุ ุชูุงู ุญูููโูุง ุฏุฑ ฺฉุฏ ฺฉุงููพุงู ุดุฏู ุงูุฌุงู ูโุดููุฏ.

ุนูุงูู ุจุฑ ุงูุ NumPy ุงุฒ ฺูุฏูุฎ ุถูู ุงุณุชูุงุฏู ูโฺฉูุฏุ ุจู ุทูุฑ ฺฉู ุญุฏุงูู ููุฏุงุฑ ููุงุฒโุณุงุฒ ุฑุฎ ูโุฏูุฏ.

(ููุงุฒโุณุงุฒ ููโุชูุงูุฏ ุจุณุงุฑ ฺฉุงุฑุขูุฏ ุจุงุดุฏ ุฒุฑุง ูุงู ุจุงูุฑ ูุจู ุงุฒ ุงูฺฉู ุงูุฏุงุฒู ุขุฑุงูโูุง `x` ู `y` ุฑุง ุจุจูุฏ ฺฉุงููพุงู ูโุดูุฏ.)


### ููุงุณู ุจุง Numba

ุญุงูุง ุจุงุฏ ุจุจูู ุขุง ูโุชูุงูู ุจุง ุงุณุชูุงุฏู ุงุฒ Numba ุจุง ฺฉ ุญููู ุณุงุฏู ุจู ุนููฺฉุฑุฏ ุจูุชุฑ ุฏุณุช ุงุจู.

```{code-cell} ipython3
import numba

@numba.jit
def compute_max_numba(grid):
    m = -np.inf
    for x in grid:
        for y in grid:
            z = np.cos(x**2 + y**2) / (1 + x**2 + y**2)
            if z > m:
                m = z
    return m

grid = np.linspace(-3, 3, 3_000)

with qe.Timer(precision=8):
    z_max_numpy = compute_max_numba(grid)

print(f"Numba result: {z_max_numpy:.6f}")
```

ุจุงุฏ ุฏูุจุงุฑู ุงุฌุฑุง ฺฉูู ุชุง ุฒูุงู ฺฉุงููพุงู ุญุฐู ุดูุฏ.

```{code-cell} ipython3
with qe.Timer(precision=8):
    compute_max_numba(grid)
```

ุจุณุชู ุจู ุฏุณุชฺฏุงู ุดูุงุ ูุณุฎู Numba ูโุชูุงูุฏ ฺฉู ฺฉูุฏุชุฑ ุง ฺฉู ุณุฑุนุชุฑ ุงุฒ NumPy ุจุงุดุฏ.

ุงุฒ ฺฉ ุทุฑูุ NumPy ูุญุงุณุจุงุช ฺฉุงุฑุขูุฏ (ูุงููุฏ Numba) ุฑุง ุจุง ููุฏุงุฑ ฺูุฏูุฎ (ุจุฑุฎูุงู ุงู ฺฉุฏ Numba) ุชุฑฺฉุจ ูโฺฉูุฏ ฺฉู ูุฒุช ูุฑุงูู ูโฺฉูุฏ.

ุงุฒ ุทุฑู ุฏฺฏุฑุ ุฑูุงู Numba ุงุฒ ุญุงูุธู ุจุณุงุฑ ฺฉูุชุฑ ุงุณุชูุงุฏู ูโฺฉูุฏุ ุฒุฑุง ูุง ููุท ุจุง ฺฉ ุดุจฺฉู ฺฉโุจุนุฏ ฺฉุงุฑ ูโฺฉูู.


### Numba ููุงุฒ ุดุฏู

ุญุงูุง ุจุงุฏ ููุงุฒโุณุงุฒ ุจุง Numba ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ `prange` ุงูุชุญุงู ฺฉูู:

ุฏุฑ ุงูุฌุง ฺฉ ุชูุงุด ุณุงุฏู ู *ูุงุฏุฑุณุช* ุขูุฏู ุงุณุช.

```{code-cell} ipython3
@numba.jit(parallel=True)
def compute_max_numba_parallel(grid):
    n = len(grid)
    m = -np.inf
    for i in numba.prange(n):
        for j in range(n):
            x = grid[i]
            y = grid[j]
            z = np.cos(x**2 + y**2) / (1 + x**2 + y**2)
            if z > m:
                m = z
    return m

```

ูุนูููุงู ุงู ูุชุฌู ูุงุฏุฑุณุช ุจุฑูโฺฏุฑุฏุงูุฏ:

```{code-cell} ipython3
z_max_parallel_incorrect = compute_max_numba_parallel(grid)
print(f"Numba result: {z_max_parallel_incorrect} ๐ฑ")
```

ุฏูู ุงู ุงุณุช ฺฉู ูุชุบุฑ `m` ุจู ูุฎโูุง ูุดุชุฑฺฉ ุงุณุช ู ุจู ุฏุฑุณุช ฺฉูุชุฑู ููโุดูุฏ.

ููุช ฺูุฏู ูุฎ ุณุน ูโฺฉููุฏ ููุฒูุงู `m` ุฑุง ุจุฎูุงููุฏ ู ุจููุณูุฏุ ุจุง ฺฉุฏฺฏุฑ ุชุฏุงุฎู ูโฺฉููุฏ.

ูุฎโูุง ููุงุฏุฑ ูุฏู `m` ุฑุง ูโุฎูุงููุฏ ุง ุจูโุฑูุฒุฑุณุงูโูุง ฺฉุฏฺฏุฑ ุฑุง ุจุงุฒููุณ ูโฺฉููุฏ --- ุง `m` ูุฑฺฏุฒ ุงุฒ ููุฏุงุฑ ุงููู ุฎูุฏ ุจูโุฑูุฒุฑุณุงู ููโุดูุฏ.

ุฏุฑ ุงูุฌุง ฺฉ ูุณุฎู ุจุง ุฏูุช ุจุดุชุฑ ููุดุชู ุดุฏู ุงุณุช.

```{code-cell} ipython3
@numba.jit(parallel=True)
def compute_max_numba_parallel(grid):
    n = len(grid)
    row_maxes = np.empty(n)
    for i in numba.prange(n):
        row_max = -np.inf
        for j in range(n):
            x = grid[i]
            y = grid[j]
            z = np.cos(x**2 + y**2) / (1 + x**2 + y**2)
            if z > row_max:
                row_max = z
        row_maxes[i] = row_max
    return np.max(row_maxes)
```

ุงฺฉููู ุจููฺฉ ฺฉุฏ ฺฉู `for i in numba.prange(n)` ุฑู ุขู ุนูู ูโฺฉูุฏ ุจู `i` ูุง ูุณุชูู ุงุณุช.

ูุฑ ูุฎ ุจู ฺฉ ุนูุตุฑ ุฌุฏุงฺฏุงูู ุงุฒ ุขุฑุงู `row_maxes` ูโููุณุฏ ู ููุงุฒโุณุงุฒ ุงูู ุงุณุช.

```{code-cell} ipython3
z_max_parallel = compute_max_numba_parallel(grid)
print(f"Numba result: {z_max_parallel:.6f}")
```

ุฏุฑ ุงูุฌุง ุฒูุงูโุจูุฏ ุขูุฏู ุงุณุช.

```{code-cell} ipython3
with qe.Timer(precision=8):
    compute_max_numba_parallel(grid)
```

ุงฺฏุฑ ฺูุฏู ูุณุชู ุฏุงุฑุฏุ ุจุงุฏ ุญุฏุงูู ุจุฑุฎ ูุฒุงุง ุฑุง ุงุฒ ููุงุฒโุณุงุฒ ุฏุฑ ุงูุฌุง ุจุจูุฏ.

ุจุฑุง ุฏุณุชฺฏุงูโูุง ูุฏุฑุชููุฏุชุฑ ู ุงูุฏุงุฒูโูุง ุดุจฺฉู ุจุฒุฑฺฏุชุฑุ ููุงุฒโุณุงุฒ ูโุชูุงูุฏ ุงูุฒุงุด ุณุฑุนุช ูุงุจู ุชูุฌู ุงุฌุงุฏ ฺฉูุฏุ ุญุช ุฑู CPU.


### ฺฉุฏ ุจุฑุฏุงุฑ ุดุฏู ุจุง JAX

ุฏุฑ ุธุงูุฑุ ฺฉุฏ ุจุฑุฏุงุฑ ุดุฏู ุฏุฑ JAX ุดุจู ุจู ฺฉุฏ NumPy ุงุณุช.

ุงูุง ุชูุงูุชโูุง ูุฒ ูุฌูุฏ ุฏุงุฑุฏ ฺฉู ุฏุฑ ุงูุฌุง ุขููุง ุฑุง ุจุฑุฌุณุชู ูโฺฉูู.

ุจุงุฏ ุจุง ุชุงุจุน ุดุฑูุน ฺฉูู.


```{code-cell} ipython3
@jax.jit
def f(x, y):
    return jnp.cos(x**2 + y**2) / (1 + x**2 + y**2)

```

ููุงููุฏ NumPyุ ุจุฑุง ุจู ุฏุณุช ุขูุฑุฏู ุดฺฉู ุฏุฑุณุช ู ูุญุงุณุจู ุญููู `for` ุชูุฏุฑุชู ุตุญุญุ ูโุชูุงูู ุงุฒ ุนููุงุช `meshgrid` ุทุฑุงุญ ุดุฏู ุจุฑุง ุงู ููุธูุฑ ุงุณุชูุงุฏู ฺฉูู:

```{code-cell} ipython3
grid = jnp.linspace(-3, 3, 3_000)
x_mesh, y_mesh = np.meshgrid(grid, grid)

with qe.Timer(precision=8):
    z_max = jnp.max(f(x_mesh, y_mesh))
    z_max.block_until_ready()

print(f"Plain vanilla JAX result: {z_max:.6f}")
```

ุจุงุฏ ุฏูุจุงุฑู ุงุฌุฑุง ฺฉูู ุชุง ุฒูุงู ฺฉุงููพุงู ุญุฐู ุดูุฏ.

```{code-cell} ipython3
with qe.Timer(precision=8):
    z_max = jnp.max(f(x_mesh, y_mesh))
    z_max.block_until_ready()
```

ูพุณ ุงุฒ ฺฉุงููพุงูุ JAX ุจู ุฏูู ุดุชุงุจ GPU ุจู ุทูุฑ ูุงุจู ุชูุฌู ุณุฑุนุชุฑ ุงุฒ NumPy ุงุณุช.

ุณุฑุจุงุฑ ฺฉุงููพุงู ฺฉ ูุฒูู ฺฉโุจุงุฑ ูุตุฑู ุงุณุช ฺฉู ุฒูุงู ฺฉู ุชุงุจุน ุจู ุทูุฑ ูฺฉุฑุฑ ูุฑุงุฎูุงู ูโุดูุฏุ ุจุงุฒฺฏุดุช ุณุฑูุงู ุฏุงุฑุฏ.


### JAX ุจู ุนูุงูู vmap

ฺฉ ูุดฺฉู ุจุง ฺฉุฏ NumPy ู ฺฉุฏ JAX ูุฌูุฏ ุฏุงุฑุฏ:

ุฏุฑ ุญุงู ฺฉู ุขุฑุงูโูุง ุชุฎุช ุญุงูุธู ฺฉู ุฏุงุฑูุฏ

```{code-cell} ipython3
grid.nbytes 
```

ุดุจฺฉูโูุง mesh ูุดุฑุฏู ุงุฒ ูุธุฑ ุญุงูุธู ูุณุชูุฏ

```{code-cell} ipython3
x_mesh.nbytes + y_mesh.nbytes
```

ุงู ุงุณุชูุงุฏู ุงุถุงู ุงุฒ ุญุงูุธู ูโุชูุงูุฏ ฺฉ ูุดฺฉู ุจุฒุฑฺฏ ุฏุฑ ูุญุงุณุจุงุช ุชุญููุงุช ูุงูุน ุจุงุดุฏ.

ุฎูุดุจุฎุชุงููุ JAX ุฑูฺฉุฑุฏ ูุชูุงูุช ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ [jax.vmap](https://docs.jax.dev/en/latest/_autosummary/jax.vmap.html) ูโูพุฐุฑุฏ.

#### ูุณุฎู 1

ุฏุฑ ุงูุฌุง ฺฉ ุฑุงู ุจุฑุง ุงุนูุงู `vmap` ุขูุฏู ุงุณุช.

```{code-cell} ipython3
# f ุฑุง ุชูุธู ฺฉูุฏ ุชุง f(x, y) ุฑุง ุฏุฑ ูุฑ x ุจุฑุง ูุฑ y ุฏุงุฏู ุดุฏู ูุญุงุณุจู ฺฉูุฏ
f_vec_x = lambda y: f(grid, y)
# ฺฉ ุชุงุจุน ุฏูู ุงุฌุงุฏ ฺฉูุฏ ฺฉู ุงู ุนููุงุช ุฑุง ุฑู ุชูุงู y ุจุฑุฏุงุฑ ฺฉูุฏ
f_vec = jax.vmap(f_vec_x)
```

ุงฺฉููู `f_vec` ููฺฏุงู ูุฑุงุฎูุงู ุจุง ุขุฑุงู ุชุฎุช `grid`ุ `f(x,y)` ุฑุง ุฏุฑ ูุฑ `x,y` ูุญุงุณุจู ูโฺฉูุฏ.

ุจุงุฏ ุฒูุงูโุจูุฏ ุฑุง ุจุจูู:

```{code-cell} ipython3
with qe.Timer(precision=8):
    z_max = jnp.max(f_vec(grid))
    z_max.block_until_ready()

print(f"JAX vmap v1 result: {z_max:.6f}")
```

```{code-cell} ipython3
with qe.Timer(precision=8):
    z_max = jnp.max(f_vec(grid))
    z_max.block_until_ready()
```

ุจุง ุงุฌุชูุงุจ ุงุฒ ุขุฑุงูโูุง ูุฑูุฏ ุจุฒุฑฺฏ `x_mesh` ู `y_mesh`ุ ุงู ูุณุฎู `vmap` ุงุฒ ุญุงูุธู ุจุณุงุฑ ฺฉูุชุฑ ุงุณุชูุงุฏู ูโฺฉูุฏ.

ููุช ุฑู CPU ุงุฌุฑุง ูโุดูุฏุ ุฒูุงู ุงุฌุฑุง ุขู ุดุจู ุจู ูุณุฎู meshgrid ุงุณุช.

ููุช ุฑู GPU ุงุฌุฑุง ูโุดูุฏุ ูุนูููุงู ุจู ุทูุฑ ูุงุจู ุชูุฌู ุณุฑุนุชุฑ ุงุณุช.

ุฏุฑ ูุงูุนุ ุงุณุชูุงุฏู ุงุฒ `vmap` ูุฒุช ุฏฺฏุฑ ุฏุงุฑุฏ: ุจู ูุง ุงุฌุงุฒู ูโุฏูุฏ ุจุฑุฏุงุฑโุณุงุฒ ุฑุง ุจู ูุฑุงุญู ุชูุณู ฺฉูู.

ุงู ููุฌุฑ ุจู ฺฉุฏ ูโุดูุฏ ฺฉู ุงุบูุจ ุฑุงุญุชโุชุฑ ุงุฒ ฺฉุฏ ุจุฑุฏุงุฑ ุดุฏู ุณูุช ูุงุจู ุฏุฑฺฉ ุงุณุช.

ูุง ุงู ุงุฏูโูุง ุฑุง ุจุดุชุฑ ููฺฏุงู ุญู ูุณุงุฆู ุจุฒุฑฺฏุชุฑ ุจุฑุฑุณ ุฎูุงูู ฺฉุฑุฏ.


### ูุณุฎู 2 vmap

ูโุชูุงูู ุจุง ุงุณุชูุงุฏู ุงุฒ vmap ููฺูุงู ฺฉุงุฑุขูุฏุชุฑ ุงุฒ ูุธุฑ ุญุงูุธู ุจุงุดู.

ุฏุฑ ุญุงู ฺฉู ุฏุฑ ูุณุฎู ูุจู ุงุฒ ุขุฑุงูโูุง ูุฑูุฏ ุจุฒุฑฺฏ ุงุฌุชูุงุจ ูโฺฉููุ ูููุฒ ุขุฑุงู ุฎุฑูุฌ ุจุฒุฑฺฏ `f(x,y)` ุฑุง ูุจู ุงุฒ ูุญุงุณุจู ุญุฏุงฺฉุซุฑ ุงุฌุงุฏ ูโฺฉูู.

ุจุงุฏ ฺฉ ุฑูฺฉุฑุฏ ฺฉู ูุชูุงูุช ุฑุง ุงูุชุญุงู ฺฉูู ฺฉู max ุฑุง ุจู ุฏุงุฎู ูโุจุฑุฏ.

ุจู ุฏูู ุงู ุชุบุฑุ ูุง ูุฑฺฏุฒ ุขุฑุงู ุฏูุจุนุฏ `f(x,y)` ุฑุง ูุญุงุณุจู ููโฺฉูู.

```{code-cell} ipython3
@jax.jit
def compute_max_vmap_v2(grid):
    # ฺฉ ุชุงุจุน ุจุณุงุฒุฏ ฺฉู ุญุฏุงฺฉุซุฑ ุฑุง ุฏุฑ ุงูุชุฏุงุฏ ูุฑ ุณุทุฑ ุจฺฏุฑุฏ
    f_vec_x_max = lambda y: jnp.max(f(grid, y))
    # ุชุงุจุน ุฑุง ุจุฑุฏุงุฑ ฺฉูุฏ ุชุง ุจุชูุงูู ุฑู ุชูุงู ุณุทุฑูุง ููุฒูุงู ูุฑุงุฎูุงู ฺฉูู
    f_vec_max = jax.vmap(f_vec_x_max)
    # ุชุงุจุน ุจุฑุฏุงุฑ ุดุฏู ุฑุง ูุฑุงุฎูุงู ฺฉูุฏ ู ุญุฏุงฺฉุซุฑ ุฑุง ุจฺฏุฑุฏ
    return jnp.max(f_vec_max(grid))
```

ุฏุฑ ุงูุฌุง

* `f_vec_x_max` ุญุฏุงฺฉุซุฑ ุฑุง ุฏุฑ ุงูุชุฏุงุฏ ูุฑ ุณุทุฑ ุฏุงุฏู ุดุฏู ูุญุงุณุจู ูโฺฉูุฏ
* `f_vec_max` ฺฉ ูุณุฎู ุจุฑุฏุงุฑ ุดุฏู ุงุณุช ฺฉู ูโุชูุงูุฏ ุญุฏุงฺฉุซุฑ ุชูุงู ุณุทุฑูุง ุฑุง ุจู ุตูุฑุช ููุงุฒ ูุญุงุณุจู ฺฉูุฏ.

ูุง ุงู ุชุงุจุน ุฑุง ุฑู ุชูุงู ุณุทุฑูุง ุงุนูุงู ูโฺฉูู ู ุณูพุณ ุญุฏุงฺฉุซุฑ max ูุง ุณุทุฑ ุฑุง ูโฺฏุฑู.

ุจุงุฏ ุขู ุฑุง ุงูุชุญุงู ฺฉูู.

```{code-cell} ipython3
with qe.Timer(precision=8):
    z_max = compute_max_vmap_v2(grid).block_until_ready()

print(f"JAX vmap v1 result: {z_max:.6f}")
```

ุจุงุฏ ุฏูุจุงุฑู ุงุฌุฑุง ฺฉูู ุชุง ุฒูุงู ฺฉุงููพุงู ุญุฐู ุดูุฏ:

```{code-cell} ipython3
with qe.Timer(precision=8):
    z_max = compute_max_vmap_v2(grid).block_until_ready()
```

ุงฺฏุฑ ุงู ุฑุง ุฑู GPU ุงุฌุฑุง ูโฺฉูุฏุ ููุงูุทูุฑ ฺฉู ูุง ุงู ฺฉุงุฑ ุฑุง ูโฺฉููุ ุจุงุฏ ุงูุฒุงุด ุณุฑุนุช ูุงุจู ุชูุฌู ุฏฺฏุฑ ุฑุง ุจุจูุฏ.


### ุฎูุงุตู

ุจู ูุธุฑ ูุงุ JAX ุจุฑูุฏู ุจุฑุง ุนููุงุช ุจุฑุฏุงุฑ ุดุฏู ุงุณุช.

ูู ุงุฒ ูุธุฑ ุณุฑุนุช (ุงุฒ ุทุฑู JIT-compilation ู ููุงุฒโุณุงุฒ) ู ูู ุงุฒ ูุธุฑ ฺฉุงุฑุง ุญุงูุธู (ุงุฒ ุทุฑู vmap) ุจุฑ NumPy ุบูุจู ูโฺฉูุฏ.

ุนูุงูู ุจุฑ ุงูุ ุฑูฺฉุฑุฏ `vmap` ฺฏุงู ุงููุงุช ูโุชูุงูุฏ ููุฌุฑ ุจู ฺฉุฏ ุจู ุทูุฑ ูุงุจู ุชูุฌู ูุงุถุญโุชุฑ ุดูุฏ.

ุฏุฑ ุญุงู ฺฉู Numba ฺุดูฺฏุฑ ุงุณุชุ ุฒุจุง JAX ุงู ุงุณุช ฺฉู ุจุง ุนููุงุช ฺฉุงููุงู ุจุฑุฏุงุฑ ุดุฏูุ ูโุชูุงูู ุฏููุงู ููุงู ฺฉุฏ ุฑุง ุฑู ุฏุณุชฺฏุงูโูุง ุจุง ุดุชุงุจโุฏููุฏู ุณุฎุชโุงูุฒุงุฑ ุงุฌุฑุง ฺฉูู ู ุจุฏูู ุชูุงุด ุงุถุงู ุงุฒ ุชูุงู ูุฒุงุง ุจูุฑูโููุฏ ุดูู.

ุนูุงูู ุจุฑ ุงูุ JAX ูุจูุงู ูโุฏุงูุฏ ฺฺฏููู ุจุณุงุฑ ุงุฒ ุนููุงุช ุขุฑุงู ุฑุงุฌ ุฑุง ุจู ุทูุฑ ูุคุซุฑ ููุงุฒ ฺฉูุฏุ ฺฉู ฺฉูุฏ ุงุฌุฑุง ุณุฑุน ุงุณุช.

ุจุฑุง ุงฺฉุซุฑ ููุงุฑุฏ ููุงุฌู ุดุฏู ุฏุฑ ุงูุชุตุงุฏุ ุงูุชุตุงุฏุณูุฌ ู ุงููุฑ ูุงูุ ุจุณุงุฑ ุจูุชุฑ ุงุณุช ฺฉู ุจุฑุง ููุงุฒโุณุงุฒ ฺฉุงุฑุขูุฏ ุจู ฺฉุงููพุงูุฑ JAX ุชุญูู ุฏูู ุชุง ุงูฺฉู ุณุน ฺฉูู ุงู ุฑูุงูโูุง ุฑุง ุฎูุฏูุงู ฺฉุฏููุณ ุฏุณุช ฺฉูู.


## ุนููุงุช ุชุฑุชุจ

ุจุฑุฎ ุนููุงุช ุฐุงุชุงู ุชุฑุชุจ ูุณุชูุฏ -- ู ุงุฒ ุงู ุฑู ุจุฑุฏุงุฑ ฺฉุฑุฏู ุขููุง ุฏุดูุงุฑ ุง ุบุฑููฺฉู ุงุณุช.

ุฏุฑ ุงู ุญุงูุช NumPy ฺฏุฒูู ุถุนู ุงุณุช ู ูุง ุจุง ุงูุชุฎุงุจ Numba ุง JAX ุจุงู ูโูุงูู.

ุจุฑุง ููุงุณู ุงู ุงูุชุฎุงุจโูุงุ ูุณุฆูู ุชฺฉุฑุงุฑ ุฑู ููุดู ุฏุฑุฌู ุฏูู ุฑุง ฺฉู ุฏุฑ {doc}`ุณุฎูุฑุงู Numba <numba>` ุฎูุฏ ุฏุฏูุ ุฏูุจุงุฑู ุจุฑุฑุณ ุฎูุงูู ฺฉุฑุฏ.


### ูุณุฎู Numba

ุฏุฑ ุงูุฌุง ูุณุฎู Numba ุขูุฏู ุงุณุช.

```{code-cell} ipython3
@numba.jit
def qm(x0, n, ฮฑ=4.0):
    x = np.empty(n+1)
    x[0] = x0
    for t in range(n):
      x[t+1] = ฮฑ * x[t] * (1 - x[t])
    return x
```

ุจุงุฏ ฺฉ ุณุฑ ุฒูุงู ุจู ุทูู 10,000,000 ุชููุฏ ฺฉูู ู ุงุฌุฑุง ุฑุง ุฒูุงูโุจูุฏ ฺฉูู:

```{code-cell} ipython3
n = 10_000_000

with qe.Timer(precision=8):
    x = qm(0.1, n)
```

ุจุงุฏ ุฏูุจุงุฑู ุงุฌุฑุง ฺฉูู ุชุง ุฒูุงู ฺฉุงููพุงู ุญุฐู ุดูุฏ:

```{code-cell} ipython3
with qe.Timer(precision=8):
    x = qm(0.1, n)
```

Numba ุงู ุนููุงุช ุชุฑุชุจ ุฑุง ุจู ุทูุฑ ุจุณุงุฑ ฺฉุงุฑุขูุฏ ูุฏุฑุช ูโฺฉูุฏ.

ุชูุฌู ฺฉูุฏ ฺฉู ุงุฌุฑุง ุฏูู ูพุณ ุงุฒ ุชฺฉูู ฺฉุงููพุงู JIT ุจู ุทูุฑ ูุงุจู ุชูุฌู ุณุฑุนุชุฑ ุงุณุช.

ฺฉุงููพุงู Numba ูุนูููุงู ุจุณุงุฑ ุณุฑุน ุงุณุช ู ุนููฺฉุฑุฏ ฺฉุฏ ุญุงุตู ุจุฑุง ุนููุงุช ุชุฑุชุจ ูุงููุฏ ุงู ุนุงู ุงุณุช.

### ูุณุฎู JAX

ุญุงูุง ุจุงุฏ ฺฉ ูุณุฎู JAX ุจุง ุงุณุชูุงุฏู ุงุฒ `lax.scan` ุงุฌุงุฏ ฺฉูู:

(ูุง `n` ุฑุง ุงุณุชุง ูฺฏู ูโุฏุงุฑู ุฒุฑุง ุจุฑ ุงูุฏุงุฒู ุขุฑุงู ุชุฃุซุฑ ูโฺฏุฐุงุฑุฏ ู ุงุฒ ุงู ุฑู JAX ูโุฎูุงูุฏ ุฑู ููุฏุงุฑ ุขู ุฏุฑ ฺฉุฏ ฺฉุงููพุงู ุดุฏู ุชุฎุตุต ุดูุฏ.)

```{code-cell} ipython3
from jax import lax
from functools import partial

cpu = jax.devices("cpu")[0]

@partial(jax.jit, static_argnums=(1,), device=cpu)
def qm_jax(x0, n, ฮฑ=4.0):
    def update(x, t):
        x_new = ฮฑ * x * (1 - x)
        return x_new, x_new

    _, x = lax.scan(update, x0, jnp.arange(n))
    return jnp.concatenate([jnp.array([x0]), x])
```

ุงู ฺฉุฏ ุฎูุงูุฏู ุขุณุงู ูุฏุงุฑุฏ ุงูุงุ ุฏุฑ ุงุตูุ `lax.scan` ุจู ุทูุฑ ูฺฉุฑุฑ `update` ุฑุง ูุฑุงุฎูุงู ูโฺฉูุฏ ู ุจุงุฒฺฏุดุชโูุง `x_new` ุฑุง ุฏุฑ ฺฉ ุขุฑุงู ุฌูุน ูโฺฉูุฏ.

```{note}
ุฎูุงููุฏฺฏุงู ุชุฒุจู ูุชูุฌู ุฎูุงููุฏ ุดุฏ ฺฉู ูุง `device=cpu` ุฑุง ุฏุฑ decorator `jax.jit` ูุดุฎุต ูโฺฉูู.

ูุญุงุณุจู ุงุฒ ุจุณุงุฑ ุนููุงุช ุชุฑุชุจ ฺฉูฺฺฉ ุชุดฺฉู ุดุฏู ุงุณุช ฺฉู ูุฑุตุช ฺฉู ุจุฑุง ุจูุฑูโุจุฑุฏุงุฑ GPU ุงุฒ ููุงุฒโุณุงุฒ ุจุงู ูโฺฏุฐุงุฑุฏ.

ุฏุฑ ูุชุฌูุ ุณุฑุจุงุฑ ุฑุงูโุงูุฏุงุฒ kernel ุชูุงู ุฏุงุฑุฏ ุฑู GPU ุบุงูุจ ุดูุฏ ู CPU ุฑุง ูุชูุงุณุจโุชุฑ ุจุฑุง ุงู ุจุงุฑ ฺฉุงุฑ ูโฺฉูุฏ.

ุฎูุงููุฏฺฏุงู ฺฉูุฌฺฉุงู ูโุชูุงููุฏ ุญุฐู ุงู ฺฏุฒูู ุฑุง ุงูุชุญุงู ฺฉููุฏ ุชุง ุจุจููุฏ ฺฺฏููู ุนููฺฉุฑุฏ ุชุบุฑ ูโฺฉูุฏ.
```

ุจุงุฏ ุขู ุฑุง ุจุง ููุงู ูพุงุฑุงูุชุฑูุง ุฒูุงูโุจูุฏ ฺฉูู:

```{code-cell} ipython3
with qe.Timer(precision=8):
    x_jax = qm_jax(0.1, n).block_until_ready()
```

ุจุงุฏ ุฏูุจุงุฑู ุงุฌุฑุง ฺฉูู ุชุง ุณุฑุจุงุฑ ฺฉุงููพุงู ุญุฐู ุดูุฏ:

```{code-cell} ipython3
with qe.Timer(precision=8):
    x_jax = qm_jax(0.1, n).block_until_ready()
```

JAX ูุฒ ุจุฑุง ุงู ุนููุงุช ุชุฑุชุจ ฺฉุงููุงู ฺฉุงุฑุขูุฏ ุงุณุช.

ูู JAX ู ูู Numba ุนููฺฉุฑุฏ ูู ูพุณ ุงุฒ ฺฉุงููพุงู ุงุฑุงุฆู ูโุฏููุฏุ ุจุง ุงู ฺฉู Numba ูุนูููุงู (ุงูุง ูู ููุดู) ุณุฑุนุชโูุง ฺฉู ุจูุชุฑ ุฏุฑ ุนููุงุช ฺฉุงููุงู ุชุฑุชุจ ุงุฑุงุฆู ูโุฏูุฏ.


### ุฎูุงุตู

ุฏุฑ ุญุงู ฺฉู ูู Numba ู ูู JAX ุนููฺฉุฑุฏ ูู ุจุฑุง ุนููุงุช ุชุฑุชุจ ุงุฑุงุฆู ูโุฏููุฏุ *ุชูุงูุชโูุง ูุงุจู ุชูุฌู ุฏุฑ ุฎูุงูุง ฺฉุฏ ู ุณูููุช ุงุณุชูุงุฏู ูุฌูุฏ ุฏุงุฑุฏ*.

ูุณุฎู Numba ุณุงุฏู ู ุทุจุน ุจุฑุง ุฎูุงูุฏู ุงุณุช: ูุง ุจู ุณุงุฏฺฏ ฺฉ ุขุฑุงู ุงุฎุชุตุงุต ูโุฏูู ู ุขู ุฑุง ุนูุตุฑ ุจู ุนูุตุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ ฺฉ ุญููู ุงุณุชุงูุฏุงุฑุฏ Python ูพุฑ ูโฺฉูู.

ุงู ุฏููุงู ูุญูู ุชูฺฉุฑ ุงฺฉุซุฑ ุจุฑูุงููโููุณุงู ุฏุฑ ููุฑุฏ ุงูฺฏูุฑุชู ุงุณุช.

ูุณุฎู JAXุ ุงุฒ ุณู ุฏฺฏุฑุ ูุงุฒ ุจู ุงุณุชูุงุฏู ุงุฒ `lax.scan` ุฏุงุฑุฏ ฺฉู ุจู ุทูุฑ ูุงุจู ุชูุฌู ฺฉูุชุฑ ุดููุฏ ุงุณุช.

ุนูุงูู ุจุฑ ุงูุ ุขุฑุงูโูุง ุชุบุฑูุงูพุฐุฑ JAX ุจู ุงู ูุนู ุงุณุช ฺฉู ููโุชูุงูู ุจู ุณุงุฏฺฏ ุนูุงุตุฑ ุขุฑุงู ุฑุง ุฏุฑ ุฌุง ุจูโุฑูุฒุฑุณุงู ฺฉูู ู ุชฺฉุฑุงุฑ ูุณุชูู ุงูฺฏูุฑุชู ููุฑุฏ ุงุณุชูุงุฏู ุชูุณุท Numba ุฑุง ุณุฎุช ูโฺฉูุฏ.

ุจุฑุง ุงู ููุน ุนููุงุช ุชุฑุชุจุ Numba ุจุฑูุฏู ูุงุถุญ ุงุฒ ูุธุฑ ูุถูุญ ฺฉุฏ ู ุณูููุช ูพุงุฏูโุณุงุฒุ ู ููฺูู ุนููฺฉุฑุฏ ุจุงูุง ุงุณุช.